# OSS-DB Silver
## 一般知識（16％）
### OSS-DBの一般的特徴　【重要度：4】
    PostgreSQLの機能概要、ライセンス、OSSのコミュニティの役割などに関する理解を問う
#### 主要な知識範囲：
##### PostgreSQLの機能全般、OSS-DBおよびOSS一般のライセンス、OSS-DBのコミュニティ、活動内容、参加方法など
* ライセンスはPostgreSQL（BSDスタイルのライセンス）
* メジャーバージョンアップは互換性がない
* メモリ容量の制限なし
* ファイルシステムレベルのI/Oアクセス
* 追記型の性能特性(INSERT,DELETEは速いが、VACUUMが必要、同時実行でロック待ち少ない)
* マルチプロセス
##### 【追加】メジャーバージョン / マイナーバージョン
##### 【追加】リリースサイクル / サポートポリシー / バグ報告

#### 重要な用語、コマンド、パラメータなど：
##### BSDライセンス
* 著作権表示は必要
##### バージョン：x.y
##### メジャーバージョン(x)
    機能追加を含んだもの
##### マイナーバージョン(y)
    セキュリティやバグ対応
##### 9系
    レプリケーションや，OLTP（Online Transaction Processing）とDWH（Data Warehouse）
* レプリケーション
* マテリアルズドビュー
* パラレルクエリ
##### 10系
    ロジカルレプリケーションとネイティブのパーティション
* パラレルクエリの強化
* プッシュダウン
* パーティション（宣言的パーティショニング）
##### 11系
    Window関数とパーティションの強化
* パラレルクエリの強化
* JITコンパイラ

### リレーショナルデータベースに関する一般知識　【重要度：4】
    リレーショナルデータベースの基本概念、一般的知識を問う
#### 主要な知識範囲：
##### リレーショナルデータモデルの基本概念

##### データベース管理システムの役割
###### 高性能
    格納された大量のデータから必要なものを高速に検索する
* ディスクI/Oの削減
* 共有メモリ
* ログ先行書き込み と チェックポイント
* チューニング
    + SQLによる最適なデータの抽出
    + 実行計画
    + 索引（INDEX）、結合（JOIN） など
###### 同時実行性
    同時に多数のユーザがデータを参照し、任意のタイミングでデータを変更する
* トランザクション
* ロック
* 読み取り一貫性
###### 耐障害性
    データを確実に保護し、万が一の障害時に復旧を可能にする
* ログ先行書き込み と チェックポイント
* 障害の種類
* バックアップ・リカバリ
##### SQL に関する一般知識
* 最新の標準規格：SQL:2016
* Postgresの対応状況：SQL:2011の一部まで（SQL:2008には完全準拠）
##### SQLの 分類 (DDL / DML / DCL) [!]
    重要な用語参照
##### データベースの設計と正規化
###### 目的
    データの重複を排除することで、データ保守を容易にする
###### 正規化
* 第１正規形：繰り返し項目の除去
* 第２正規形：主キーに対してすべての非キー属性が完全関数従属
* 第３正規形：すべての非キー属性がどの候補キーに対しても推移的に関数従属していない

#### 重要な用語、コマンド、パラメータなど：
##### DDL(Data Definition Language)
* CREATE TEBLE
##### DML(Data Manipulation Language)
* UPDATE/DELETE/INSERT
##### DCL(Data Control Language)
* GRANT/REVOKE/COMMIT/ROLLBACK


## 運用管理（52％）
### インストール方法　【重要度：2】
    PostgreSQLのインストール方法、データベースクラスタの作成方法などに関する理解を問う
#### 主要な知識範囲：
##### インストール
1. yumやapt-get等のパッケージ管理システムからインストール
2. rpmやexeなどのパッケージからインストール
3. ソースからインストール
##### initdbコマンドの使い方 [!]
* https://www.postgresql.jp/document/11/html/app-initdb.html
* ロケール：--locale
    + Postgresでは主にデータのソート処理に使用する
    + デフォルトはOSのロケールを使用
    + バイナリ値を基準にしたい場合、initdb --locale=C または、--no-locale を指定する
* 文字エンコーディングの指定：--encoding
    + デフォルトは、sql_ascii
    + クライアントの文字セットとして、Shift-JISをサポートしている
    + データベース毎に異なる文字セットを使うことができる（createdbまたはCREATE DATABASE文のオプションで指定）
    + ターミナルでマルチバイト文字を扱えないので、明示的にUTF-8辺りを指定するべき
* データベースクラスタのディレクトリ指定：--pgdata
* スーパーユーザのパスワード設定：--pwfile/--pwprompt
##### データベースクラスタの概念と構造 [!]
###### 概念
* テンプレートデータベースを含む、複数のデータベースの集合体
* デフォルトでは1台のマシン上に構成するが、$PGDATAや受付ポートを複数用意することで複数のデータベースクラスタを稼働させることができる
###### 構造
| 内容                 | 指定方法        | ディレクトリ |
|:---------------------|---------------:|:---------:|
| データディレクトリ     | initdb -D     | $PGDATA|
| WALファイル出力先      | initdb -X     | $PGDATA/pg_wal|
| ユーザデータ格納先     | TABLESPACE機能| $PGDATA/base|
| ログファイル出力先     | パラメータ     | $PGDATA/log|
| アーカイブ退避先       | パラメータ     | <指定した出力先>|
| 状態管理・設定ファイル群| --            | postgresql.conf、pg_hba.conf 他|

##### テンプレートデータベース [!]
* pg_databaseのdatistemplateがtrueになっているデータベース
* データベースをテンプレートデータベースにするには、システムカタログpg_databaseのdatistemplateをtrueに設定する
* CREATEDB権限があれば、複製できる
* データの更新やデータベース削除などは通常のデータベース同様の処理ができる
* template0は削除することができない
* template0は誤って更新されることを防ぐため、pg_databaseのdatallowconnがfalseになっており、スーパーユーザも含め、誰も接続できないようになっている。
* テンプレートデータベースを作成するには、CREATE DATABASEコマンドの実行時にIS_TEMPLATEをtrueに指定します。
* ALTER DATABASEコマンドでIS_TEMPLATEをtrueあるいはfalseに指定することで、通常のデータベースをテンプレートデータベースに変更すること、あるいはその逆が行えます。

#### 重要な用語、コマンド、パラメータなど：
##### データベースクラスタ
    1つ以上のデータベースと、管理情報・設定ファイルが集まったもの 
* PostgreSQLは、データベースクラスタ単位で起動・停止を行う 
* 実体は構築時に指定するPostgreSQL関連の最上位のディレクトリ
       (ディレクトリを指す場合は、「データディレクトリ」と記載される) 
* 環境変数$PGDATAにデータディレクトリのパスを設定しておく
##### initdb
    データベースクラスタの初期化 
* コマンド：pg_ctl initdb
* データベースクラスタは、セキュリティ上の理由から、データベースクラスタを作成したユーザ(initdbを実行したデータベース管理者ユーザ)以外は読み書きができないようになっています
##### PGDATA
* initdb -D でも指定可能
##### template0
    システムの標準オブジェクトのみが含まれる読み取り専用のデータベース
##### template1
    ひな形データベース(デフォルト)

### 標準付属ツールの使い方 【重要度：5】
    コマンドプロンプトから実行できる管理用ツールの使い方を問う
#### 主要な知識範囲：
##### データベース管理用コマンドの使い方

#### 重要な用語、コマンド、パラメータなど：
##### pg_ctl [●]
* start:サービス起動
* stop:サービス停止
* restart:サービス再起動
* reload:設定再読込
* status:状態表示
* promote:スタンバイ昇格
* kill:強制終了
* register:Winサービス登録
* unregister:Winサービス解除
##### pg_isready
    データベース稼働状態の確認（死活監視）
##### createuser [●]
    データベースユーザの作成
* 初期ユーザ(一般にpostgresユーザと表記される)はスーパーユーザ
* スーパーユーザもしくは CREATEROLE 権限を持っていれば実行でき、OSのユーザアカウントとは無関係
* ログイン属性を持つユーザを作成 
    + (SQL)CREATE ROLE文
* オプション：
    + -c: 新しいユーザの最大接続数、デフォルトは無限大
    + -d: 新しいユーザにデータベースの作成権限を付与する
    + -D: 新しいユーザにデータベースの作成権限を付与しない（デフォルト）
    + -r: ユーザ（ロール）作成の権限を与える
    + -s: スーパユーザ権限を与える
##### dropuser
    データベースユーザの削除
##### createdb
    データベースの作成
##### dropdb
    データベースの削除
##### psql
    データベースに接続、SQL発行
* --list：データベースの一覧を表示（pg_databaseというシステムカタログからも取得可能）
##### メタコマンド
    \で始まる（\hなどがある）
* \l database：データベース表示
* \c database：データベース切替
* \q：psql接続の終了
* \d：テーブル、ビュー、およびシーケンスの一覧を表示
    + \d <テーブル名>：テーブルの列名と列属性の一覧を表示
* \list：データベースの一覧を表示

### 設定ファイル 【重要度：5】
    設定ファイルの使い方、基本的な設定パラメータに関する知識を問う
#### 主要な知識範囲：
##### postgresql.confに関する以下の4項目
1. 記述方法
2. 接続と認証
3. クライアント接続デフォルト
4. エラー報告とログ取得
##### pg_hba.confの設定方法

##### SET/SHOWの使い方
* 有効範囲はセッション単位、あるいはトランザクション単位に限定される
* LOCALオプションを指定するとトランザクション単位となる
* lc_messagesなど一部のパラメータの設定変更にはスーパユーザ権限が必要
#### 重要な用語、コマンド、パラメータなど：
##### postgresql.conf
###### メモリ関連
* shared_buffers
    + 共有バッファサイズを指定します。（デフォルト値は32MB）
* work_mem
    + 内部並び替えとハッシュテーブル操作が使用するメモリーサイズを指定します。（デフォルト値は1MB）
###### WAL関連
* wal_buffers
    + WALバッファサイズを設定します。（デフォルト値はshared_buffersの1/32のサイズ）
* checkpoint_segments
    + チェックポイントの処理を実行するタイミングをWALセグメントの数で設定します。（デフォルト値は3）
* checkpoint_timeout
    + チェックポイントの処理を実行するタイミングを設定しますが、こちらは時間間隔で設定します。（デフォルト値は5m）
###### アクセス制限の指定
* listen_addresses
###### テーブルスキーマの設定
* search_path
    + デフォルトは "$user", public
    + スキーマ検索パスの設定によって、SQL文のオブジェクト名の指定でスキーマ名を省略した場合、どのスキーマのオブジェクトを使うかを特定する
###### 再起動が必要な設定
* port
* max_connection
###### チェックポイント関連
* max_wal_size
* checkpoint_timeout
###### ログ関連
* log_destination
    + stderr、csvlog、syslog といった出力方法を指定
* logging_collector
    + on にすることで、標準エラー出力に送られたログメッセージをログファイルにリダイレクトできる。
* log_connections
    + on にすることで、クライアントからサーバへの接続試行がログに出力される。
* log_statement
    + どの SQL 文をログに記録するかを制御するパラメータで、有効な値は none、ddl、mod、all （デフォルトはnone）
* log_line_prefix
    + 各ログ行の先頭に出力する書式文字列
* log_min_messages
    + エラーレベルの設定
##### pg_hba.conf
* 接続タイプ、接続先DB、ユーザ名、接続ホスト名、認証方法
* データベースに接続するときの認証方式を記載
* アクセス制限の指定
    + セキュリティ上、trust の指定はしないようにする
##### pg_ctl reload/restart
    設定ファイルの再読み込みと再起動
##### 【追加】pg_settings
    設定の詳細を参照する

### バックアップ方法 【重要度：7】
    PostgreSQLのバックアップ方法に関する理解を問う
#### 主要な知識範囲：
##### バックアップの種類
###### 論理的バックアップ
* pg_dump / pg_dumpall
* SQLをそのまま保存する。
* 無停止かつお手軽に実施できるが、バックアップした時点までしか戻せない。
###### 物理的バックアップ
* サーバを止めてデータファイルをコピーする。
* 多くの場合，論理バックアップより高速に実施できる。
* バックアップした時点までしか戻せない
###### コールド/ホット バックアップ
* サーバーを停止してバックアップを行うか行わないかの違い
###### PITR
* pg_basebackup の流れ
    1. pg_start_backup();
    2. tarコマンドによる物理的バックアップ 
    3. pg_stop_backup();
##### 各種バックアップコマンドの使い方
* pg_dump / pg_dumpall
##### ファイルシステムレベルのバックアップとリストア
* データベースを停止する必要がある
* データベースクラスタ全体をバックアップする必要がある
* 論理バックアップに比べると、ファイルシステムのコピーによるバックアップは一般的に高速である。
##### ポイントインタイムリカバリ(PITR)の概念と手順
* データベースクラスタ全体で動作（特定のデータベースのみをバックアップすることはできない）
* 無停止でデータファイルとWALアーカイブをコピーする
* 最新状態までの任意の時点に戻せるが、運用コストは高くなる
##### 【追加】トランザクションログ(WAL)とWALアーカイブ [!]
* 更新内容が書かれている「WALレコード」単位で構成され最大16Mバイト
* WALレコードにはLSN（Log Sequence Number）とよばれる番号が振られている
* max_wal_size の値によりファイルの総数が決まり、ファイルの総数に達すると、古いファイルから上書かれていく
* 上書きによるWALの消失を防ぐために、WALアーカイブファイルとして残すこともできる
* WALライタプロセスによってWALバッファのデータが書き込まれる
##### 【追加】pg_start_backup() / pg_stop_backup()
* データベースクラスタ全体をtarなどのOS付属のコマンドを利用して物理的にコピーすることでベースバックアップを作成する。このとき、バックアップの取得前後に管理ユーザにて実行する
##### COPY文(SQL)、¥copyコマンド(psql)の使い方 [!]
* 標準SQLにはない、PostgreSQL独自拡張機能
* テーブルのデータのバックアップやリストアなどに使用することができる
* ファイルの入出力をする場合は、スーパーユーザ権限が必要だが、TO STDIN/OUTの指定により標準入出力となるので、一般ユーザでも実行できる
* pg_dumpコマンドで作成したテキスト形式のバックアップからリストアするとき、デフォルトではCOPY文が利用される
#### 重要な用語、コマンド、パラメータなど：
##### pg_dump
    論理バックアップの取得（SQLコマンドが含まれる場合がある）
* プレーンテキスト形式（SQL）
* カスタムアーカイブ形式（圧縮したバイナリ）[●]
* ディレクトリ形式（表単位で圧縮したバイナリ）
* TAR形式（表単位のバイナリ）
##### pg_dumpall
    データベースクラスタ全体のバックアップを取得する
* テキスト形式のみ
* グローバルオブジェクトのバックアップが可能
##### pg_restore
    論理バックアップを利用したリストア（pg_dumpコマンドと並列実行可能）
* バイナリ形式のバックアップの場合に使用する
##### psql
    データベースに接続、SQL発行
* テキスト形式のバックアップの場合に使用する
##### pg_basebackup
    物理バックアップにはレプリケーションプロトコルが用いられ、リモートで動作している別サーバからもベースバックアップを取得することができます。
* wal_level
* archive_mode
* archive_command
* max_wal_senders
    + バックアップ用に少なくとも１つのセッションを残すように十分高く設定する必要があります。
##### PITR
    PITRはPoint In Time Recoveryで、バックアップをもとに任意の時点へ復元させれます。
    ストリーミングレプリケーションと合わせて利用し、復元には、任意のリストアポイント・任意のトランザクションID・最後のWALログ位置・任意の時刻)を指定します。
    recovery_target_timelineをデフォルト値の場合、ベースバックアップ取得時の最新のタイムラインに回復します。
1. postgresql.conf設定
```
wal_level = archive or host_standby
#archiveはログをを追加します。hot_standbyは更にスタンバイ上の読取専用の問い合わせが可能です。
archive_mode = on
#archive_commandとセットで設定します。
archive_command = 'cp %p /tmp/postgres/%f'
#WALファイルを退避させるアーカイブコマンドを設定します。
```
2. postgresql再起動
```
# service postgresql-9.6 restart
```
3. ベースバックアップの開始
```
postgres=# select pg_start_backup('base.tar.gz')
```
4. ファイルコピー
```
# mkdir /tmp/postgres/
# mkdir /tmp/postgres/base
# chown -R postgres:postgres /tmp/postgres
# tar czf /tmp/postgres/base/base.tar.gz /var/lib/pgsql/9.6/data
```
5. ベースバックアップの終了
```
postgres=# select pg_stop_backup();
```
6. アーカイブログの確認
```
# /usr/pgsql-9.6/bin/pgbench -i -s 3
# /usr/pgsql-9.6/bin/pgbench
# ls -l /tmp/postgres/
```
##### 【追加】recovery.conf
    PITRを利用したリストアの流れを次に記載します。
1. postgresqlサービス停止
```
# service postgresql-9.6 stop
```
2. ベースファイルの解凍
```
# cd /
# tar zxf /tmp/postgres/base/base.tar.gz
```
3. リカバリ設定
```
# rm -fr /var/lib/pgsql/9.6/data/pg_xlog/*
# vi /var/lib/pgsql/9.6/data/recovery.conf
```
4. recovery.confの設定
```
restore_command = 'cp /tmp/postgres/%f %p'
#archive_commandの逆を設定します。
#recovery_target_name =
#今回は設定しませんが、リストアポイントを設定します。
#recovery_target_time =
#今回は設定しませんが、リカバリしたい時刻を設定します。
#recovery_target_xid =
#今回は設定しませんが、リカバリしたいxidを設定します。
#リカバリ設定をしない場合、最後のWAL位置までリカバリします。
#設定を２つ以上指定したた場合、最後に指定されたものが使われます。
#初期状態では最後までリストアします。
* restore_command
* recovery_target_time
* archivecleanup_command
```
5. postgresqlサービス起動
```
# chown postgres:postgres /var/lib/pgsql/9.6/data/recovery.conf
# service postgresql-9.6 start
※/var/lib/pgsql/9.6/data/recovery.doneが存在すればリカバリ完了です。
```
##### リカバリ制御関数
###### pg_is_xlog_replay_paused()
    リカバリが停止中であれば真を返す
###### pg_xlog_replay_pause()
    即座にリカバリを停止する(スーパーユーザに限定)
###### pg_xlog_replay_resume()
    もしリカバリ停止中であれば再開する(スーパーユーザに限定)
##### COPY
* COPY テーブル名 TO 出力先; 
* サーバで処理される
* COPY文ではテーブルしか指定できない制限がある
* 出力形式のデフォルトはタブ区切りのテキスト形式
* オプション：
    + FORMAT
    + DELIMITER
##### ¥copy
* クライアントで処理される

### 基本的な運用管理作業 【重要度：7】
    データベース管理者として実行する基本的な運用管理コマンドに関する知識を問う
#### 主要な知識範囲：
##### 【追加】PostgreSQLの起動・停止方法
* PostgreSQLデータベースのサーバプロセスの終了は、データベースの管理者ユーザが行う
* 停止するときに接続中のセッションをどうするのか終了モードを設定することができる
    + smart/fast/immediate（デフォルトはfast）
##### 【追加】データベースロール / ユーザの概念

##### 【変更】データベースロール / ユーザの追加・削除・変更方法

##### VACUUM、ANALYZEの目的と使い方 
* 追記型アーキテクチャ：1行の更新であっても、繰り返すことでデータが肥大化していく 
###### VACUUMの目的
    不要な行を定期的に削除するVACUUM処理が必要
###### ANALYZEの目的
    問い合わせプランナが最適な実行計画を作成するために利用される
##### 自動バキュームの概念と動作
    トランザクションIDの周回問題を回避するために実行される
* VACUUM、ANALYZEを自動的に実行する
* デフォルトで有効
* VACUUMは通常の更新を妨げないよう、該当行にのみ弱いロックを必要とする 
    + VACUUMと競合する処理が明示された場合、VACUUMがキャンセルされる 
    + VACUUMのオプションとして、ロック強度が強く、効果が高いコマンドも存在（VACUUM FULL）
* データ更新量に依存して起動され、経過時間やデータベース負荷は関係が無い
##### システム情報関数

##### 情報スキーマとシステムカタログ
* 情報スキーマ：データベース内のオブジェクトに関する様々な情報を提供する
    + information_schema
    + 標準SQLの機能として定義されているため、PostgreSQL 以外の RDBMS でも利用でき、ビューの名前、および多くのカラム名は他の RDBMS でも同じ
    + スキーマ検索パスにユーザ名が使われるように、スキーマ名とユーザ名には緩いつながりがありますが、実装上はこれらは独立していて、スキーマはユーザ名と無関係に作成できます
* pg_tables：テーブルに関する情報（テーブル名、スキーマ名、所有者）を表示するシステムビューで、一般ユーザでも利用することができる
* pg_views：ビューに関する情報を表示するシステムビュー
* pg_statistic：収集した統計情報を格納する
##### テーブル単位の権限（GRANT/REVOKE） [!]
* デフォルトではテーブルの作成者（所有者）のみがすべての権限を所持しており、他のユーザは一切の権限を所持していません
* スーパーユーザは特殊なユーザで、アクセス権限がなくても、テーブルにアクセスすることができます
* UPDATE権限だけでなく、WHERE句で参照する列についてのSELECT権限も必要となります
* テーブル自体を削除(DROP)するのは、テーブルの所有者に限られ、その権限をGRANTで付与することはできない
* 権限は指定されたユーザに対するものとなり、PUBLICに対して指定があった場合は全体に影響が残る

#### 重要な用語、コマンド、パラメータなど：
##### 【追加】pg_ctl start / stop
    データベースクラスタの起動と停止
##### 【変更】CREATE/ALTER/DROP ROLE/USER
* ALTER USER：ユーザの属性や権限などを変更する [●]
    + オプションで PASSWORDを指定することで、ユーザのパスワードを設定あるいは変更できます。
    + オプションで VALID UNTILを指定することで、ユーザのパスワードが無効になる日時（タイムスタンプ）を設定あるいは変更できます。
    + オプションで CREATEROLE あるいは NOCREATEROLEを指定することで、新しいユーザを作成する権限の有無を変更できます。
    + オプションで LOGIN あるいは NOLOGINを指定することで、データベースクラスタに接続する権限を変更できます。
    + 内部的にALTER ROLEを実行する
##### VACUUM
* タプルの更新・削除によって使用されなくなったデータ領域を回収する
    + 通常のバキュームは、削除済みになっているデータ領域を更新することで、次にINSERT が実行されたときにその領域にデータが挿入されるようにするものなので、データファイルのサイズは変更されません。
* FULLオプション：FULLオプションを指定すると、postgresqlは、更新/削除された行の切り詰めを行う。（データファイルサイズが小さくなる）
##### ANALYZE
* テーブル内にどのようなデータが入っているかを調べる
* テーブルの統計情報を取得して問い合わせの計画の最適化のもとにする
* オプション指定により、対象を、データベース内の全テーブル、あるいは、データベース内の特定のテーブルのみ、特定のテーブルの特定の列のみ、などに制限できる
##### vacuumdb
    VAUUMを実行するコマンド
##### 【追加】autovacuum
    postgresql.conf：自動VACUUMの実行有無設定
##### current_user [●]
    現在のユーザ名を取得
* カッコ不要に注意
##### version

##### information_schema
    情報スキーマは information_schema というスキーマ内のビューとして実現されている
##### GRANT
    アクセスを許可する
##### REVOKE
    許可したアクセス権限を取り消す


## 開発/SQL（32％）
### SQL コマンド 【重要度： 13】
    基本的なSQL文およびデータベースの構成要素に関する知識を問う
#### 主要な知識範囲：
##### SELECT 文
##### INSERT 文
##### UPDATE 文
##### DELETE 文
##### データ型
    PostgreSQLのデータ型には数値データ型、通貨型、文字型、バイナリ列データ型、日付/時刻データ型、論理値データ型、 列挙型、幾何データ型、ネットワークアドレス型、ビット列データ型、テキスト検索に関する型、UUID型、XML型、JSONデータ型、 配列、複合型、範囲型、オブジェクト識別子データ型、疑似データ型があります。
##### テーブル定義

##### インデックス

##### ビュー
* ビューからSELECTするときは、ビューに対するSELECT権限だけがあれば良い
* ビューを既存のテーブルと同じ名前にすることはできない
##### 【追加】マテリアライズドビュー
    実体化されたビューの事
* REFRESH MATERIALIZED VIEW
##### ルール

##### トリガー
* TRIGGER型の関数を作成する
* CREATE TRIGGER トリガー名 トリガー ON テーブル名 処理 関数名;
* 複数のトリガーがある場合、実行順はトリガー名でソートした順序なので、トリガー名に依存する
* ビューにINSTEAD OFトリガーを定義することで、ビューを更新することもできる（更新したいビューが更新可能ビューでない場合に使用する）
##### シーケンス
* CREATE SEQUENCE
* テーブルに格納されるデータが連番になるとは限らない
* データが1行だけのシーケンスのSELECTは特殊なテーブルを返却する
##### スキーマ

##### 【追加】テーブルスペース
* 下記を作成する際の場所をデフォルトとは異なる場所に指定できる
    + データベース
    + テーブル
    + インデックス
##### 【追加】パーティション [!]
* 条件（日や月単位、地域など）によって、データを複数に分割して格納することができる
* 頻繁に使うレコードが存在するパーティションをキャッシュ出来る
* グローバルインデックスはできない
* INSERT実行時の格納先となるパーティションは、事前に作成しておく必要がある
##### 関数定義 / 【追加】プロシージャ定義

##### PL/pgSQL

##### 引用符
* 一重引用符：文字列リテラル
* 二重引用符：テーブル名や列名のオブジェクト名に使用
    + 記号を含めたり、大文字と小文字を区別する

#### 重要な用語、コマンド、パラメータなど：
##### SELECT
##### DML：INSERT/UPDATE/DELETE
* DMLの対象行はロックされ、別トランザクションの操作を待機させる
##### FROM

##### JOIN
* INNER JOIN
* LEFT OUTER JOIN
* RIGHT JOIN
* FULL JOIN：LEFTとRIGHT、両方のJOINを適用する
* USING：結合に使用する列名が2つのテーブルで同じときにのみ使用できる簡略記法で、USINGの後に結合に使用する列のリストをかっこで囲んで記述する
* NATURAL JOIN：USINGを省略できる
##### WHERE

##### INTO

##### VALUES

##### SET [●]

##### LIMIT

##### OFFSET

##### ORDER BY

##### DISTINCT

##### GROUP BY

##### HAVING

##### EXISTS

##### IN

##### NOT

##### 数値データ型
* SMALLINT：２バイト整数
* INTEGER：４バイト整数
* BIGINT：８バイト整数
* NUMERIC：４バイト１０進数の整数または小数、正確
* DECIMAL：可変長ユーザ指定精度、正確
* REAL：４バイト可変精度、不正確
* DOUBLE PRECISION：８バイト可変精度、不正確
##### シーケンス（数値データ型）
* SMALLSERIAL：２バイト狭範囲自動増分整数
* SERIAL：４バイト自動増分整数
    + NOT NULL 制約が自動設定される
    + 列の値を指定しないか、DEFAULTを指定することで自動採番となる
* BIGSERIAL：８バイト広範囲自動増分整数
##### 通貨型
* MONEY：８バイト貨幣金額
##### 文字列型
* CHAR：空白で埋められた固定長(TOAST圧縮有)
* VARCHAR：4バイト+上限付き可変長(TOAST圧縮有)
* TEXT：4バイト+制限なし可変長(TOAST圧縮有)
* CHARACTER：4バイト+上限付き可変長
* CHARACTER VARYING：4バイト+空白で埋められた固定長
##### 日付型
* DATE：4バイト 日付（時刻なし）
* TIME：8バイト 時刻（日付なし）
* TIMESTAMP：8バイト 日付と時刻両方、時間帯付き
* INTERVAL：12バイト 時間間隔
    + 日時計算の際に期間を表す
##### 論理値型：BOOLEAN
* 文字列の’true’,‘t’, ‘yes’, ‘y’, ‘on’, ‘1’をTRUEの代わりに、’false’, ‘f’, ‘no’, ‘n’, ‘off’,‘0’をFALSEの代わりに使うことができる
* ’1’と’0’も文字列であって、整数の1と0は使えない
* SELECT文で値を表示する場合、TRUEならばt、FALSEならばfの1文字だけが表示される
##### 【追加】BYTEA

##### NULL

##### DDL：CREATE/ALTER/DROP TABLE [●]
* CREATE TABLE
    + テーブルを作成するには、作成先のスキーマへのCREATE権限が必要
* ALTER TABLE
    + ALTER COLUMNにより列の属性(データ型、デフォルト値など)を変更することはできるが、UNIQUE制約を追加することはできない
    + ADDによりテーブルの制約を追加できる
##### 制約：PRIMARY KEY

##### 制約：FOREIGN KEY

##### 制約：REFERENCES
* FOREIGN KEY (自テーブルの列) REFERENCES参照先テーブル名 (参照列)
##### 制約：UNIQUE KEY

##### 制約：NOT NULL

##### 制約：CHECK

##### DEFAULT

##### 【追加】CREATE/ALTER/DROP | INDEX/VIEW/MATERIALIZED VIEW/RULE/TRIGGER/SCHEMA/SEQUENCE/TABLESPACE/FUNCTION/PROCEDURE
* TABLESPACE：表領域の作成 [●]
* FUNCTION：ユーザ定義関数の作成
* PROCEDURE：ストアドプロシージャの作成
* MATERIALIZED VIEW：マテリアライズドビューの作成
* VIEW：ビューの作成
    + CREATE OR REPLACE VIEWコマンドでビューの定義を変更するとき、ビューに列を追加することはできるが、減らすことはできない
* INDEX
    + PRIMARY KEY、UNIQUEの制約がある列については自動的に作成される
    + デフォルトでは、B-Treeのインデックスが作成される（他はハッシュやGiST）
* UNIQUE INDEX：一意のインデックスの作成
##### 【追加】CREATE TABLE PARTITION BY/OF [●]
* 
##### 【追加】ALTER TABLE ATTACH/DETACH PARTITION

##### 制御
* FOR LOOP ~ END LOOP 
* WHILE
* FOREACH
##### UNION：和集合

### 組み込み関数 【重要度：2】
    データベースで標準的に利用できる関数および演算子に関する知識を問う
#### 主要な知識範囲：
##### 集約関数

##### 算術関数

##### 演算子

##### 文字列関数

##### 文字列演算子 / 述語

##### 時間関数

#### 重要な用語、コマンド、パラメータなど：
##### 集約関数
* count
##### 算術関数
* sum
* avg
    + 平均値はNUMERIC型で返却される
* max
* min
##### 文字列関数
* char(character)_length
    + 文字列の長さを調べる
* lower
* upper
* substring
    + substring(対象文字列 from 開始位置 for 長さ)：標準SQL指定
    + substring(対象文字列,開始位置 [, 長さ]) 
* replace
* trim
##### 文字列演算子
* ||
* ~
    + PostgreSQL関数：正規表現とのマッチングが可能となる
* LIKE
    + PostgreSQL関数：ILIKE、LIKE演算子の大文字と小文字を区別しないバージョン
* SIMILAR TO
##### 時間関数
* age
    + 2つの日付の間の期間を年月日で求める
* now
    + 現在日時を取得する
##### current_date [●]
    現在日付のみ取得
##### current_timestamp / 【追加】statement_timestamp / 【追加】clock_timestamp [●]
* 同じトランザクション内では、同じ時刻を返す
##### current_time [●]
    現在時刻のみ取得
##### extract
    日時型の年月日指定部分を取得
* PostgreSQL関数：date_part
##### to_char
    目的のフォーマットに合わせて出力する
##### abs
    絶対値を求める関数
* @演算子でも同じ

### トランザクションの概念 【重要度：1】
    トランザクション機能に関する知識を問う
##### 現実の処理をコンピュータで扱うための考え方 
    トランザクション内の命令をまとめて（現実世界での）1つの操作とみなす
##### ACID特性
###### Atomicity(原子性)
    トランザクションに含まれる一連の処理は、全体として実行されるか、実行されないかのいずれかであることが保証されるという性質。
* 何らかの障害により処理が途中で止まってしまった場合、処理途中のデータを格納するのではなく、処理を実行していない状態を維持するということ。
###### Consistency(一貫性)
    あらかじめ指定したルールに沿った形で処理が行われるという性質。
* 例えば、あるカラムに対してuniqueという条件を指定した場合に、そのカラム内で重複しないことを保証するもの。
###### Isolation(独立性)
    ある処理について、外部から見ることができるのは実行前と実行後のデータだけであり、実行中のデータの状態を見ることができないという性質。
###### Durability(永続性)
    ある処理が完了した段階で、その出力結果は永続的に失われることのないものとしてデータベースに記録されるという性質。
##### ロック
    適切なロックを獲得する（獲得できない場合は待機する）ことで、同時に同じデータ が複数人から更新されることを防ぎ、また、同時に反映されるべきある一連の更新は、 読み取り一貫性により他者から途中の段階を見られることは無い。 
##### 不整合
###### ダーティリード
    他のトランザクションが更新した未コミット状態のデータを読み込んでしまうこと。
###### 反復不能読み取り
    トランザクション内で同じレコードを2回読み込んだとき、読み込み間隔内に他のトランザクションが該当レコードの更新をコミットしたことで、1回目と2回目の読み込み結果が変わってしまうこと。
###### ファントムリード
    トランザクション内で同一条件のレコード抽出を2回行ったとき、読み込み間隔内に他のトランザクションがレコードの挿入/削除をコミットしたことで、1回目と2回目の結果のレコード数が変わってしまうこと。
##### ロングトランザクションの弊害
    ロングトランザクションは長時間にわたりコミットもロールバックも行われないトランザクションを指します。その間、トランザクションの対象となったテーブルはロックされることになり、それが長時間に及ぶとさまざまな弊害が発生します。
* VACUUMは実行中のトランザクションが参照する可能性のある不要領域を回収できません。
* トランザクション中に発生しているロックのため、メンテナンス系のコマンドはトランザクション完了まで待たされることになります。
* pg_stat_activityのxact_startを監視する

#### 主要な知識範囲：
##### トランザクションの構文
    PostgreSQLのトランザクション機能では、途中のSQL文がエラーを起こすと、トランザクション自体がエラーになったとみなされ、以後のSQL文がすべてエラーになる
* BEGINで開始/COMMITで完了もしくはROLLBACKで破棄するまで
##### 【変更】トランザクション分離レベル
###### リードアンコミッティド
    未コミット状態のデータであっても読み込む
* PostgreSQLではRead Committedとして動作するので、ダーティーリードは発生しません。
###### リードコミッティド
    コミットされたデータのみを読み込む（ダーティーリードの禁止）
###### リピータブルリード
    トランザクション中は他のトランザクションでコミットされた更新を参照しないことで、同じレコードを繰り返し読んでも常に同じ結果が得られることを保証する（反復不能読み取りの禁止）
* PostgreSQLのRepeatable Readはファントムリードが起こらない実装になっています。
###### シリアライザブル
    トランザクションの逐次実行をエミュレートし、直列的に実行した場合と同じ結果になることを保証する
##### LOCK 文

##### 行ロックとテーブルロック
    同じ行に対する更新を防ぐ仕組み 
* DMLの対象行はロックされ、別トランザクションの操作を待機させる
##### 【追加】デッドロック
    2つのトランザクションがロックを取り合う状態 
* 片方がエラーになりトランザクション失敗 
* 他方はロック待ちが終わり成功

#### 重要な用語、コマンド、パラメータなど：
##### BEGIN

##### COMMIT

##### ROLLBACK

##### SAVEPOINT [?]

##### SET TRANSACTION

##### LOCK TABLE

##### 【追加】SELECT FOR UPDATE / SHARE

## その他
### メモリ領域
#### 共有メモリ 
    共有メモリとはすべてのプロセスで共有する領域。大きく分けて共有バッファとWALバッファが存在する。
##### 共有バッファ 
    ディスクから読み取ったデータをキャッシュして、以降のユーザ要求に高速に応答 
* デフォルト値：shared_buffers = 128MB
* 実メモリが１GB以上の場合は1/4程度。Winodws上では512MB以内に設定
##### WALバッファ 
    耐障害性とパフォーマンスを両立するための仕組み 
* デフォルト値：wal_buffers = -1 は shared_buffers の1/32が自動設定
* ログ先行書き込み(Write Ahead Logging) 
* WALファイルのサイズと同じ16MBが最大値
#### セッションメモリ 
    セッション毎に確保される領域 
##### ワークメモリ 
    ソートやハッシュの一時領域。不足すると一時ファイルを作成して処理する
* デフォルト値：work_mem = 4MB
##### メンテナンスワークメモリ 
* デフォルト値：maintenance_work_mem = 64MB
* メンテナンス操作(バキュームやインデックス作成)に使用

### プロセス
    PostgreSQLではマルチプロセスモデルを採用。プロセスは大きく分けてマスタサーバプロセス、バックグラウンドプロセス、バックエンドプロセスが存在する。
#### 必須プロセス 
##### postgres(postmaster)、postgres backend 
    クライアントからの接続を待ち受ける、writer, wal writer, autovacuum launcher, stats collector などのプロセスの親プロセス 
* postgresプロセスによって起動され、クライアントからの処理を担当 
* データベースクラスタ1つに対して、postmaster というプロセス
##### writer [●]
    共有バッファのデータをディスクに書き込むプロセス 
* チェックポイントやダーティバッファの書き込み 
##### wal writer [●]
    データの変更履歴をWALファイルに書き込む
#### パラメータ設定により起動するプロセス 
##### logger [●]
    PostgreSQLサーバ実行時のログを記録するプロセス 
* パラメータ設定により有効化し、何をどこに保存するか指定できる 
##### archive [●]
    チェックポイント以前の不要なWALをPITRのために別のディスクに退避 
##### autovacuum launcher/worker [●]
    自動VACUUMを実行 
##### stats collector [●]
    実行時統計情報を収集する
#### チューニング
##### writer
    ライタプロセスによるテーブルファイルへの書き込みが大量に発生すると、問い合わせ性能がおちる
###### bgwriter_delay
    ライタプロセスの動作周期
###### bgwriter_lru_maxpages
    一度にライタプロセスが書き込むページ数の上限
###### bgwriter_lru_multiplier
    書き込みが必要になったページのうち、どのくらいの割合を書き込むべきか計算する際に使用

### プロセスとメモリとファイルの関係
* WALバッファ -> WALライタプロセス -> WALファイル
    + UPDATEなどの更新処理が発生した場合、まずWALバッファに更新情報が書き込まれる
    + COMMITを行った契機でWALバッファの情報がWALライタプロセスによってWALファイルに書き込まれる
* 共有バッファ -> ライタプロセス（or チェックポインタ） -> テーブルファイル・インデックスファイル
    + UPDATEなどの更新処理が発生した場合、まず共有バッファ上のデータが更新される
    + この更新された情報（ダーティーページ）はすぐにはデータファイルには反映されない 
        - 随時データファイルへの書き込みを行うとI/Oが頻発してパフォーマンス上よろしくない
* ダーティーページのデータファイルへの書き込みはライタプロセスおよびチェックポインタで行われる 
    + 書き込み時はI/Oが発生するので、問い合わせが遅くなる原因にもなる

### 表領域
* 表と索引を別のディスクに配置することでパフォーマンス向上を図ることができる。
* 表領域としてはディレクトリ名を指定し、そのディレクトリ内に表や索引がファイルとして作成される。
* 表領域を作成していない状態では、すべての表や索引は、データベースクラスタ内の base ディレクトリの下に作成される。

### 用語
#### tablespace
    データをBASEとは別の場所に保存　
#### TPS　 
    1秒間に実行できたトランザクションの数(Transactions Per Second)
#### カレントスキーマ　 
    publicスキーマ(スキーマ名を指定せずに作られるときに入る)
#### libpqプロトコル　
    共通ライブラリでこれがバックエンドとの通信(クライアント)
#### FILLFACTOR
    ブロックに確保する空き領域指定
#### WAL　
    トランザクションログ(先行書き込み)
    walファイルはメモリ上の内容がファイルに反映された時点で不要
#### PITR　
    ポイント・イン・タイム・リカバリでWALログ(アーカイブ含む)で最新まで復元可能
#### coreファイル　
    プロセスが異常終了したときのメモリ内容ダンプ
#### gdbコマンド　 
    プログラムが異常終了したときに何が行われたかの調査
#### checkpoint
    ログ内の情報を反映するために全てのデータファイルを更新、トランザクションログのある一時点。
#### アクセス統計情報　
    稼働統計情報
#### 統計情報　
    プランナが使用する(検索などにindexの利用判断)レコード数など。
#### GUC　
    Grand Unified Configuration の略で、PostgreSQLの動的に変更できるパラメータを管理するモジュール。postgresql.conf ファイルやPGOPTIONS環境変数、SETコマンドなどで設定できるパラメータを管理しているモジュール。
#### pgAdmin4　
    こちらはPostgreSQLをGUIで操作するアプリ。
#### GEQO 
    遺伝的問い合わせ最適化といいFROM句の項目数が増加すると結合の組み合せがそれにより増加し解析にかかる時間が指数的に増加するため、それを軽減するためのものです。
#### Visibility Map　
    ページ内にトランザクションによって更新され参照することができなくなったタプルがあるかの管理。
#### カーディナリティ　
    カラム内のユニーク性が高いかどうかの判断。
#### FSM　
    Free Space Mapで再利用可能領域。
#### プリペアド　
    性能を最適化するために利用可能なサーバ側のオブジェクト。
#### Heap　
    テーブルデータ。
#### HOT　
    Heap Only TupleでHeapのみのTuple。
#### ファストパス　
    サーバへの簡単な関数呼び出しを送信する近道 
